{% extends 'main/base.html' %}
{% load custom_tags %}

{% block title %}Checklist Detail{% endblock %}
<style>
    .btn-success {
        padding: 8px 20px;
        font-weight: 500;
    }
    .btn-success i {
        margin-right: 5px;
    }
    .card-header .btn-success {
        background-color: #28a745;
        border-color: #28a745;
        color: white;
    }
    .card-header .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }

    .measurement-value {
        font-family: monospace;
        padding: 2px 6px;
        background-color: #f8f9fa;
        border-radius: 3px;
    }
    
    .checklist-status {
        min-width: 120px;
        text-align: center;
    }
    
    .validation-badge {
        min-width: 50px;
        display: inline-block;
    }
    
    .measurement-table th {
        width: 35%;
        font-weight: 500;
    }
    
    .timeline-item {
        padding: 15px;
        border-left: 3px solid #dee2e6;
        margin-bottom: 10px;
        background-color: #f8f9fa;
    }
    
    .timeline-item.warning {
        border-left-color: #ffc107;
    }
    
    .timeline-item.success {
        border-left-color: #28a745;
    }
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: none;
        margin-bottom: 1.5rem;
    }
    .info-card {
        transition: transform 0.2s;
        background: #fff;
        border-radius: 10px;
    }
    .info-card:hover {
        transform: translateY(-5px);
    }
    .status-badge {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
    }
    .metric-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    .progress {
        height: 10px;
        border-radius: 5px;
    }
    .card-header {
        border-bottom: none;
        padding: 1.5rem;
    }
    .metric-value {
        font-size: 1.25rem;
        font-weight: 600;
    }
    .metric-label {
        color: #6c757d;
        font-size: 0.875rem;
    }

    </style>
    
{% block content %}
<div class="container">

    <!-- Critical Issues Alert -->
    {% if measurement_validation.critical_issues %}
    <div class="alert-container bg-red-50 p-4 mb-6">
        <div class="flex items-start space-x-4">
            <div class="flex-shrink-0">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <div>
                <h3 class="text-lg font-medium text-red-800">Quality Control Issues Detected</h3>
                <div class="mt-2 text-sm text-red-700">
                    <ul class="list-disc pl-5 space-y-1">
                        {% for issue in measurement_validation.critical_issues %}
                        <li>{{ issue.message }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    
    <!-- Header Information -->
    <div class="card">
        <!-- Header -->
        <div class="card-header bg-primary text-white rounded-top">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">Daily Verification/Inspection Sheet #{{ checklist.id }}</h4>
                    <small class="text-white-50">Generated on {{ checklist.shift.date }}</small>
                </div>
                <div class="d-flex gap-3">
                    <div class="px-3 py-2 bg-white bg-opacity-25 rounded">
                        <i class="fas fa-clipboard-check me-2"></i>
                        {{ subgroup_metrics.total_count }}/6 Measurements
                    </div>
                    {% comment %} <div class="status-badge rounded 
                        {% if checklist.status == 'pending' %}bg-warning
                        {% elif checklist.status == 'supervisor_approved' %}bg-info
                        {% elif checklist.status == 'quality_approved' %}bg-success
                        {% else %}bg-danger{% endif %}">
                        <i class="fas fa-circle-check me-2"></i>
                        {{ checklist.get_status_display }}
                    </div> {% endcomment %}
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="card-body p-4">
            <div class="row g-4">
                <!-- Production Information -->
                <div class="col-md-6 col-lg-3">
                    <div class="info-card h-100 p-4 border rounded">
                        <div class="metric-icon text-primary">
                            <i class="fas fa-industry"></i>
                        </div>
                        <h6 class="text-muted mb-4">Production Information</h6>
                        <div class="mb-3">
                            <div class="metric-label">Date</div>
                            <div class="metric-value">{{ checklist.shift.date }}</div>
                        </div>
                        <div>
                            <div class="metric-label">Shift</div>
                            <div class="metric-value">{{ checklist.shift.get_shift_type_display }}</div>
                        </div>
                    </div>
                </div>

                <!-- Personnel -->
                <div class="col-md-6 col-lg-3">
                    <div class="info-card h-100 p-4 border rounded">
                        <div class="metric-icon text-success">
                            <i class="fas fa-user-gear"></i>
                        </div>
                        <h6 class="text-muted mb-4">Personnel</h6>
                        <div class="mb-3">
                            <div class="metric-label">Operator</div>
                            <div class="metric-value">{{ checklist.shift.operator.username }}</div>
                        </div>
                        <div>
                            <div class="metric-label">Program Selection (HMI)</div>
                            <div class="metric-value">{{ checklist.selected_model }}</div>
                        </div>
                    </div>
                </div>

                <!-- Timing -->
                <div class="col-md-6 col-lg-3">
                    <div class="info-card h-100 p-4 border rounded">
                        <div class="metric-icon text-info">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h6 class="text-muted mb-4">Timing Metrics</h6>
                        <div class="mb-3">
                            <div class="metric-label">Started</div>
                            <div class="metric-value">{{ checklist.created_at|date:"Y-m-d H:i" }}</div>
                        </div>
                        <div>
                            <div class="metric-label">Duration</div>
                            <div class="metric-value">{{ timing_metrics.total_duration|floatformat:1 }} hours</div>
                        </div>
                    </div>
                </div>

                <!-- Progress -->
                <div class="col-md-6 col-lg-3">
                    <div class="info-card h-100 p-4 border rounded">
                        <div class="metric-icon text-warning">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h6 class="text-muted mb-4">Status & Progress</h6>
                        <div class="mb-3">
                            <div class="metric-label">Completion</div>
                            <div class="progress mb-2">
                                <div class="progress-bar {% if subgroup_metrics.completion_percentage == 100 %}bg-success{% else %}bg-primary{% endif %}"
                                     role="progressbar"
                                     style="width: {{ subgroup_metrics.completion_percentage }}%">
                                </div>
                            </div>
                            <div class="metric-value text-end">
                                {{ subgroup_metrics.completion_percentage|floatformat:0 }}%
                            </div>
                        </div>
                        <div>
                            <div class="metric-label">Current Status</div>
                            <div class="metric-value">{{ checklist.get_status_display }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Initial Measurements -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Initial Quality Control Measurements</h5>
                <span class="badge {% if measurement_validation.all_base_ok %}bg-success{% else %}bg-danger{% endif %}">
                    {% if measurement_validation.all_base_ok %}All Parameters Within Range{% else %}Parameters Out of Range{% endif %}
                </span>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Pressure Measurements -->
                    <div class="col-md-6">
                        <table class="table table-sm measurement-table">
                            <tbody>
                                <tr>
                                    <th scope="row">Line pressure  (4.5 - 5.5 bar) </th>
                                    <td>
                                        <span class="measurement-value">{{ checklist.line_pressure }} bar</span>
                                        <span class="validation-badge badge {% if measurement_validation.base_measurements.line_pressure_ok %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if measurement_validation.base_measurements.line_pressure_ok %}In Range{% else %}Out of Range{% endif %}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row">UV  Flow input Test Pressure(13+/- 2 KPa) (11-15) kPA </th>
                                    <td>
                                        <span class="measurement-value">{{ checklist.uv_flow_input_pressure }} kPa</span>
                                        <span class="validation-badge badge {% if measurement_validation.base_measurements.uv_flow_input_ok %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if measurement_validation.base_measurements.uv_flow_input_ok %}In Range{% else %}Out of Range{% endif %}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row">Test Pressure for Vacumm generation (0.25 ~ 0.3 Mpa)</th>
                                    <td>
                                        <span class="measurement-value">{{ checklist.test_pressure_vacuum }} MPa</span>
                                        <span class="validation-badge badge {% if measurement_validation.base_measurements.test_pressure_ok %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if measurement_validation.base_measurements.test_pressure_ok %}In Range{% else %}Out of Range{% endif %}
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Quality Checks -->
                    <div class="col-md-6">
                        <table class="table table-sm measurement-table">
                            <tbody>
                                <tr>
                                    <th scope="row">O-ring  conditon(UV Flow check sealing area), should not be damaged (O-ring सील की स्थिति सही होनी चाहिए)</th>
                                    <td>
                                        <span class="badge {% if checklist.oring_condition == 'OK' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ checklist.oring_condition }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row">Master Verification for LVDT (OK/NG)</th>
                                    <td>
                                        <span class="badge {% if checklist.master_verification_lvdt == 'OK' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ checklist.master_verification_lvdt }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row">Good and Bad master verification (refer EPVS)</th>
                                    <td>
                                        <span class="badge {% if checklist.good_bad_master_verification == 'OK' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ checklist.good_bad_master_verification }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row">Tool Alignmnet (Top & Bottom) (Tool Alignment) सही होना चाहिए</th>
                                    <td>
                                        <span class="badge {% if checklist.tool_alignment == 'OK' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ checklist.tool_alignment }}
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        # Tool IDs and Part Numbers
                        <table>

                            <tr>
                                <th scope="row">Tool top_tool_id  </th>
                                <td>
                                  
                                        {{ checklist.top_tool_id }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">bottom_tool_id  </th>
                                <td>
                                  
                                        {{ checklist.bottom_tool_id }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">Tool uv_assy_stage_id  </th>
                                <td>
                                  
                                        {{ checklist.uv_assy_stage_id }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">Tool retainer_part_no  </th>
                                <td>
                                  
                                        {{ checklist.retainer_part_no }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">Tool uv_clip_part_no  </th>
                                <td>
                                  
                                        {{ checklist.uv_clip_part_no }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                            <tr>
                                <th scope="row">Tool umbrella_part_no  </th>
                                <td>
                                  
                                        {{ checklist.umbrella_part_no }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">Tool retainer_id_lubrication  </th>
                                <td>
                                  
                                        {{ checklist.retainer_id_lubrication }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">Tool error_proofing_verification  </th>
                                <td>
                                  
                                        {{ checklist.error_proofing_verification }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Subgroup Measurements -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center bg-light">
                <div>
                    <h5 class="mb-0">Periodic Measurement Records</h5>
                    <small class="text-muted">2-Hour Interval Measurements</small>
                </div>
                {% if can_add_subgroup %}
                <a href="{% url 'add_subgroup' checklist.id %}" class="btn btn-primary">
                    <i class="fas fa-plus-circle me-2"></i>Record New Measurement
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if subgroups %}
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">Sequence</th>
                                <th>Time</th>
                                <th>UV  Vaccum Test range(-35 to -43 KPa) (kPa)</th>
                                <th>UV Flow Value (30~40 LPM)(HMI) (LPM)</th>
                                <th>Umbrella Valve Assembly in Retainer in UV Assy Station</th>
                                <th>UV Clip pressing -proper locking of 2 nos snap</th>
                                <th>All workstations are clean (Y/N) वर्कस्टेशन साफ होना चाहिए (हाँ/ना)</th>
                                <th>contamination (Y/N) PTGW_5.3_PC_GUR_03</th>
                                <th>Verification Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subgroup in subgroups %}
                            <tr>
                                <td class="text-center"><strong>#{{ subgroup.subgroup_number }}</strong></td>
                                <td>{{ subgroup.timestamp|time:"H:i" }}</td>
                                <td>
                                    <span class="measurement-value">{{ subgroup.uv_vacuum_test }}</span>
                                    <span class="badge {% if subgroup.validation_status.uv_vacuum_test_ok %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if subgroup.validation_status.uv_vacuum_test_ok %}In Range{% else %}Out of Range{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <span class="measurement-value">{{ subgroup.uv_flow_value }}</span>
                                    <span class="badge {% if subgroup.validation_status.uv_flow_value_ok %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if subgroup.validation_status.uv_flow_value_ok %}In Range{% else %}Out of Range{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {% if subgroup.umbrella_valve_assembly == 'OK' %}bg-success{% else %}bg-danger{% endif %}">
                                        Assembly {{ subgroup.umbrella_valve_assembly }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {% if subgroup.uv_clip_pressing == 'OK' %}bg-success{% else %}bg-danger{% endif %}">
                                        Assembly {{ subgroup.uv_clip_pressing }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {% if subgroup.workstation_clean == 'OK' %}bg-success{% else %}bg-danger{% endif %}">
                                        Assembly {{ subgroup.workstation_clean }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {% if subgroup.bin_contamination_check == 'OK' %}bg-success{% else %}bg-danger{% endif %}">
                                        Assembly {{ subgroup.bin_contamination_check }}
                                    </span>
                                </td>
  

                                <td>
                                    <div class="d-flex flex-column gap-1">
                                        <!-- Supervisor Verification Status -->
                                        <div class="card border-light mb-2">
                                            <div class="card-body p-2">
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <small class="text-muted">Supervisor:</small>
                                                    {% with supervisor_verification=subgroup.verifications.filter|divisibleby:'supervisor' %}
                                                        {% if supervisor_verification %}
                                                            {% if supervisor_verification.status == 'rejected' %}
                                                                <span class="badge bg-danger">Rejected</span>
                                                            {% else %}
                                                                <span class="badge bg-success">Approved</span>
                                                            {% endif %}
                                                            <small class="text-muted ms-2">
                                                                {{ supervisor_verification.verified_at|timesince }} ago
                                                            </small>
                                                            {% if supervisor_verification.comments %}
                                                                <div class="small text-muted mt-1">
                                                                    <strong>Comment:</strong> {{ supervisor_verification.comments }}
                                                                </div>
                                                            {% endif %}
                                                            {% if user.user_type == 'shift_supervisor' %}
                                                                <a href="{% url 'edit_verification' supervisor_verification.id %}" 
                                                                   class="btn btn-sm btn-outline-secondary mt-1">
                                                                    <i class="fas fa-edit"></i> Edit Verification
                                                                </a>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="badge bg-warning">Pending</span>
                                                        {% endif %}
                                                    {% endwith %}
                                                </div>
                                            </div>
                                        </div>
                                
                                        <!-- Quality Verification Status -->
                                        <div class="card border-light">
                                            <div class="card-body p-2">
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <small class="text-muted">Quality:</small>
                                                    {% with supervisor_verification=subgroup.verifications.filter|divisibleby:'supervisor' quality_verification=subgroup.verifications.filter|divisibleby:'quality' %}
                                                        {% if quality_verification %}
                                                            {% if quality_verification.status == 'rejected' %}
                                                                <span class="badge bg-danger">Rejected</span>
                                                            {% else %}
                                                                <span class="badge bg-success">Approved</span>
                                                            {% endif %}
                                                            <small class="text-muted ms-2">
                                                                {{ quality_verification.verified_at|timesince }} ago
                                                            </small>
                                                            {% if quality_verification.comments %}
                                                                <div class="small text-muted mt-1">
                                                                    <strong>Comment:</strong> {{ quality_verification.comments }}
                                                                </div>
                                                            {% endif %}
                                                            {% if user.user_type == 'quality_supervisor' %}
                                                                <a href="{% url 'edit_verification' quality_verification.id %}" 
                                                                   class="btn btn-sm btn-outline-secondary mt-1">
                                                                    <i class="fas fa-edit"></i> Edit Verification
                                                                </a>
                                                            {% endif %}
                                                        {% else %}
                                                            {% if supervisor_verification.status == 'rejected' %}
                                                                <span class="badge bg-secondary">Waiting</span>
                                                            {% elif supervisor_verification %}
                                                                <span class="badge bg-warning">Pending</span>
                                                            {% else %}
                                                                <span class="badge bg-secondary">Waiting</span>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endwith %}
                                                </div>
                                            </div>
                                        </div>
                                
                                        <!-- Verify Button -->
                                        {% with supervisor_verification=subgroup.verifications.filter|divisibleby:'supervisor' quality_verification=subgroup.verifications.filter|divisibleby:'quality' %}
                                            {% if user.user_type == 'shift_supervisor' and not supervisor_verification %}
                                                <a href="{% url 'verify_subgroup_measurement' subgroup.id %}" class="btn btn-sm btn-outline-primary mt-1">
                                                    Verify
                                                </a>
                                            {% elif user.user_type == 'quality_supervisor' and supervisor_verification and not quality_verification and supervisor_verification.status != 'rejected' %}
                                                <a href="{% url 'verify_subgroup_measurement' subgroup.id %}" class="btn btn-sm btn-outline-primary mt-1">
                                                    Verify
                                                </a>
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                </td>
                                                                <td>
                                    {% if user.user_type == 'operator' and checklist.status == 'pending' %}
                                    <a href="{% url 'edit_subgroup' checklist.id subgroup.id %}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                    <!-- Measurement Progress -->
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Measurement Progress</h6>
                            <small class="text-muted">Target: 6 measurements</small>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-primary" 
                                 role="progressbar" 
                                 style="width: {{ total_subgroups|multiply:16.67 }}%">
                                {{ total_subgroups }}/6 Complete
                            </div>
                        </div>
                    </div>

                    {% else %}
                    <div class="text-center py-5">
                        <p class="text-muted mb-3">No measurements recorded</p>
                        {% if checklist.status == 'pending' %}
                        <a href="{% url 'add_subgroup' checklist.id %}" class="btn btn-primary">
                            <i class="fas fa-plus-circle me-2"></i>Record First Measurement
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Verification and Concerns -->
<div class="row">
    <!-- Verification Section -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Quality Verifications</h5>
                <div>
                    {% if verification_status.can_verify_supervisor %}
                    <a href="{% url 'supervisor_verify' checklist.id %}" class="btn btn-success">
                        <i class="fas fa-check-circle me-2"></i>Supervisor Verification
                    </a>
                    {% elif verification_status.can_verify_quality %}
                    <a href="{% url 'quality_verify' checklist.id %}" class="btn btn-success">
                        <i class="fas fa-check-circle me-2"></i>Quality Verification
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if checklist.verifications.exists %}
                <div class="timeline-container">
                    {% for verification in checklist.verifications.all %}
                    <div class="timeline-item {% if verification.verified_by.user_type == 'quality_supervisor' %}success{% else %}warning{% endif %}">
                        <h6 class="mb-1">{{ verification.get_verifier_type_display }}</h6>
                        <p class="mb-1">Verified by: {{ verification.verified_by.get_full_name }}</p>
                        <small class="text-muted">{{ verification.verified_at|date:"Y-m-d H:i" }}</small>
                        {% if verification.comments %}
                        <p class="mt-2 mb-0 text-muted">{{ verification.comments }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0">No verifications recorded</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Concerns Section -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Quality Concerns</h5>
                {% if checklist.status != 'quality_approved' %}
                <a href="{% url 'add_concern' checklist.id %}" class="btn btn-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>Report Concern
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if concerns %}
                <div class="accordion" id="concernsAccordion">
                    {% for concern in concerns %}
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-{{ forloop.counter }}">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <span>Concern Report #{{ forloop.counter }}</span>
                                    <span class="badge {% if concern.is_resolved %}bg-success{% else %}bg-warning{% endif %}">
                                        {% if concern.is_resolved %}Resolved{% else %}Open{% endif %}
                                    </span>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse-{{ forloop.counter }}" 
                             class="accordion-collapse collapse" 
                             data-bs-parent="#concernsAccordion">
                            <div class="accordion-body">
                                <p><strong>Description:</strong><br>{{ concern.concern.concern_identified }}</p>
                                {% if concern.concern.cause_if_known %}
                                <p><strong>Root Cause:</strong><br>{{ concern.concern.cause_if_known }}</p>
                                {% endif %}
                                {% if concern.concern.action_taken %}
                                <p><strong>Resolution:</strong><br>{{ concern.concern.action_taken }}</p>
                                {% endif %}
                                <div class="mt-3">
                                    <small class="text-muted">
                                        Reported: {{ concern.concern.created_at|date:"Y-m-d H:i" }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0">No quality concerns reported</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
});
});
</script>
{% endblock %}